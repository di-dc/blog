<?xml version="1.0" encoding="UTF-8"?><rss xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:atom="http://www.w3.org/2005/Atom" version="2.0" xmlns:media="http://search.yahoo.com/mrss/"><channel><title><![CDATA[foundation - danisaacs.net]]></title><description><![CDATA[Things I want to remember]]></description><link>https://blog.danisaacs.net/</link><image><url>https://blog.danisaacs.net/favicon.png</url><title>foundation - danisaacs.net</title><link>https://blog.danisaacs.net/</link></image><generator>Ghost 4.32</generator><lastBuildDate>Thu, 17 Feb 2022 04:12:48 GMT</lastBuildDate><atom:link href="https://blog.danisaacs.net/tag/foundation/rss/" rel="self" type="application/rss+xml"/><ttl>60</ttl><item><title><![CDATA[Running with Foundation]]></title><description><![CDATA[Getting started with Foundation, the Optimizely reference site.]]></description><link>https://blog.danisaacs.net/running-with-foundation/</link><guid isPermaLink="false">620d9db7b71c9400018985a9</guid><category><![CDATA[optimizely]]></category><category><![CDATA[foundation]]></category><dc:creator><![CDATA[Dan Isaacs]]></dc:creator><pubDate>Thu, 17 Feb 2022 02:51:25 GMT</pubDate><media:content url="https://blog.danisaacs.net/content/images/2022/02/foundation.png" medium="image"/><content:encoded><![CDATA[<img src="https://blog.danisaacs.net/content/images/2022/02/foundation.png" alt="Running with Foundation"><p>If you&apos;re reading this, you&apos;ve probably already heard of Foundation, our <a href="https://www.optimizely.com/">Optimizely</a> &#xA0;(formerly Episerver) Content Cloud + B2C Commerce Cloud reference site. Want to run a local instance for testing or evaluation purposes? Want to use it as a starter site for a build? No problem &#x2013; it&apos;s freely available up in GitHub: <a href="https://github.com/episerver/Foundation">https://github.com/episerver/Foundation</a>. Below I&apos;m going to walk through a few tips + tricks on getting it running, but first two important callouts: </p><ol><li>Use the latest &amp; greatest! This article is focused on the CMS 12 / Commerce 14 version, running on .NET 5. If you want to use the earlier version, you can still follow the setup steps detailed in the readme on the (at the time of this writing) <em>master </em>branch. (But really, that&apos;d be a mistake &#x2013; .NET 5 is the way to go.)</li><li>I&apos;m focused here on the full version of Foundation &#x2013; there&apos;s also a <a href="https://github.com/episerver/foundation-mvc-cms">CMS-only version</a> if that&apos;s more your bag. (I think most of the instructions below should apply to that one, but I make no promises!)</li></ol><h3 id="getting-ready">Getting ready</h3><p>As noted above, the repository is at: <a href="https://github.com/episerver/Foundation">https://github.com/episerver/Foundation</a> &#x2013; for .NET5 (at least at the moment) you&apos;ll want to be working with the <a href="https://github.com/episerver/Foundation/tree/main"><em>main</em> branch</a>.</p><figure class="kg-card kg-image-card"><img src="https://blog.danisaacs.net/content/images/2022/02/foundation-select-main-branch-e.png" class="kg-image" alt="Running with Foundation" loading="lazy" width="231" height="312"></figure><p>Take a look at the readme to see the system requirements. On Windows, make you&apos;ll want SQL Server, Node.JS, and .NET5 runtime. (And some other stuff for running under IIS, but I&apos;ll cover that below.) For Mac/Linux (we can run on Mac and Linux now! Exciting!), the setup requires Docker (for SQL Server). You could approach that in other ways, but it&apos;s not built in to the setup script.</p><h3 id="running-locally">Running locally</h3><p>If you just want to run things locally (for example, for dev or for evaluation purposes), setup is a breeze. Just follow the instructions in the readme for your system type. </p><p>The only pro-tip I&apos;d throw in here is to update your <em>appsettings.json</em> file with a valid Optimizely Search &amp; Navigation (AKA Optimizely Find (AKA Episerver Find)) index before running the solution. Don&apos;t have an index? Sign up at <a href="https://find.episerver.com">https://find.episerver.com</a> and generate a free dev index, and then add the index and service URL details:</p><figure class="kg-card kg-image-card kg-card-hascaption"><img src="https://blog.danisaacs.net/content/images/2022/02/find.png" class="kg-image" alt="Running with Foundation" loading="lazy" width="446" height="103"><figcaption>changeme!</figcaption></figure><p>After executing the <em>dotnet run...</em> command, wait until new warnings stop being shown, and then pull up your browser and hit <em>http://localhost:5000</em>. (If it doesn&apos;t load or you get a &quot;connection refused&quot; message, try again in 30 seconds. The first time up can take a minute or two or three, as it does some initialization steps and content imports.)</p><p>To stop the site, press Ctrl-C in your Powershell window (you may need to hit it a few times, if your laptop&apos;s like mine).</p><h3 id="graduating-to-iis">Graduating to IIS</h3><p>Ready to step it up, and run under IIS? It&apos;s not all that different, but there are a few gotchas to be aware of.</p><p>Note: this is not intended to be an in-depth tutorial on all details of IIS setup. For a deeper dive into creating an IIS site for Optimizely CMS running on .NET 5, a more detailed write-up can be found here: <u><a href="https://www.jondjones.com/learn-optimizely/cms/how-to-install-optimizely-cms-12-and-configure-a-development-environment/">https://www.jondjones.com/learn-optimizely/cms/how-to-install-optimizely-cms-12-and-configure-a-development-environment/</a></u></p><h4 id="iis-server-setup-one-time-only">IIS server setup (one-time-only!)</h4><p>That said: if this is your first time setting up a .NET 5 site in IIS, you must install the .NET 5 IIS module. Download and install the &#x201C;Hosting Bundle&#x201D; from: <u><a href="https://dotnet.microsoft.com/download/dotnet/5.0">https://dotnet.microsoft.com/download/dotnet/5.0</a></u></p><figure class="kg-card kg-image-card"><img src="https://blog.danisaacs.net/content/images/2022/02/iis-hosting-bundle-2.png" class="kg-image" alt="Running with Foundation" loading="lazy" width="516" height="302"></figure><h4 id="get-the-code">Get the code</h4><p>Download the code from the GitHub repository. (Note: several options to complete this step are presented below, depending on your familiarity with Git. Or you can skip past this step because you already know how to do it. It&apos;s your world, I&apos;m just living in it.)</p><p>In all cases, I&apos;m assuming the root of the repo is in the folder <em>\foundation.</em></p><h5 id="option-1-download-the-main-branch-from-the-repository-as-a-zip-file">Option 1: download the main branch from the repository as a ZIP file</h5><ol><li>Open the repo in your web browser:</li><li>Change to the &#x201C;<em>main</em>&#x201D; branch</li><li>Click the &#x201C;Code&#x201D; button, and select &#x201C;Download ZIP&#x201D;</li><li>After the file has downloaded, right click and select &#x201C;Properties&#x201D;. Check the &#x201C;Unblock&#x201D; box and click OK.</li><li>Unzip the file to a folder</li></ol><h5 id="option-2-command-line-clone-the-repository-and-then-checkout-the-main-branch">Option 2: command line! Clone the repository and then checkout the main branch</h5><ol><li>Clone the repo:<br><em>git clone https://github.com/episerver/foundation.git</em></li><li>Go into the &#x201C;foundation&#x201D; directory where you cloned the repo</li><li>Check out the main branch:<br><em>git checkout main</em></li></ol><h5 id="option-3-more-command-line-clone-checkout-the-main-branch-in-one-step">Option 3: more command line! Clone + checkout the main branch in one step</h5><ol><li>Clone and checkout the <em>main </em>branch:<br><em>git clone -b main https://github.com/episerver/foundation.git</em></li></ol><h4 id="update-appsettingsjson">Update appsettings.json</h4><p>Remember earlier when I wrote about adding a Find (search) index to the <em>appsettings.json</em>? Do that. It might save some headaches (search is pretty integral to the Foundation site).</p><h4 id="have-a-license">Have a license?</h4><p>If you have a license (in the form of a <em>License.config</em> file), copy it to the site directory:<br>	<em>\foundation\src\Foundation\</em> </p><p>Note: a license file isn&#x2019;t needed for running under localhost. You might be able to sign up for a demo license at <a href="https://license.episerver.com/">https://license.episerver.com/</a>.</p><h4 id="run-the-setup">Run the setup</h4><p>Return to the root folder and run the <em>setup.cmd</em> script as an administrator &#x2013; this will create and configure the database, and some other initial setup. (Note, the &#x201C;app name&#x201D; property will just be used in the database names &#x2013; it will not create an IIS site during this process.)</p><figure class="kg-card kg-image-card"><img src="https://blog.danisaacs.net/content/images/2022/02/code-setup.jpg" class="kg-image" alt="Running with Foundation" loading="lazy" width="640" height="427" srcset="https://blog.danisaacs.net/content/images/size/w600/2022/02/code-setup.jpg 600w, https://blog.danisaacs.net/content/images/2022/02/code-setup.jpg 640w"></figure><h4 id="publish-the-site">Publish the site</h4><p>First, create a publish folder -- I created it in the root repository folder (<em>\foundation</em>) and called it &#x201C;publish&#x201D;, so it had the following path:</p><p><em>	\foundation\publish</em></p><p>Now, open a command line (I like Powershell, myself).</p><ol><li>Switch to the site root directory: <em>c:\whatever\your\path\is\foundation</em></li><li>Publish to the directory you just created (this example assumes the path I used; adjust the path to your publish folder as needed):</li></ol><p><em>	dotnet publish -c Debug -o .\publish /p:EnvironmentName=Development</em></p><p>(Once you have your site up and running, subsequent publishes can be tricky &#x2013; I&apos;m going to include some notes at the bottom of this article around that, but for now this should be all you need.)</p><h4 id="set-up-the-site-in-iis">Set up the site in IIS</h4><p>We&apos;re almost there! (Note to self (left publicly to remind me later): maybe this should be scripted and included as an optional step in the setup?) Until then &#x2013; open up IIS.</p><ol><li>Create a new site (right click &quot;Sites&quot; and select &quot;Add Website&#x2026;&quot;)</li><li>Site name: foundation-net5 [you can use anything you want here]</li><li>Physical path: full path to the &#x201C;publish&#x201D; folder created in the earlier step</li><li>Host name: the url you want to use to access the site.<br><br>Fun tip: if you&#x2019;re just interested in setting the site up in IIS but don&#x2019;t need to access it externally --<br><br>If you use the domain &quot;mysite.localmachine.name&quot; (substituting anything for &quot;mysite&quot;), you can set it up locally in IIS without needing to update your hosts file. For example, I used foundation-net5.localmachine.name. (For more info -- <a href="https://www.david-tec.com/2013/07/Never-edit-your-hosts-file-again-when-working-on-localhost/" rel="noreferrer noopener">https://www.david-tec.com/2013/07/Never-edit-your-hosts-file-again-when-working-on-localhost/</a> -- thanks, David!)</li></ol><p>When you created the site, it will have automatically created an app pool. You&apos;re going to need to update the Application Pool settings to avoid errors with OpenIDConnect:</p><p>Right click the Application Pool created when you created the site in the previous step (by default, it should have the same name as the site), and select &#x201C;Advanced Settings&#x201D;</p><figure class="kg-card kg-image-card"><img src="https://blog.danisaacs.net/content/images/2022/02/app-pool-setup-01-e.png" class="kg-image" alt="Running with Foundation" loading="lazy" width="324" height="188"></figure><p>Find the &#x201C;Identity&#x201D; setting, and click the dots to open the menu to change the setting</p><figure class="kg-card kg-image-card"><img src="https://blog.danisaacs.net/content/images/2022/02/app-pool-setup-02-e.png" class="kg-image" alt="Running with Foundation" loading="lazy" width="505" height="85"></figure><p>Change the setting to &#x201C;LocalSystem&#x201D;, and click OK</p><figure class="kg-card kg-image-card"><img src="https://blog.danisaacs.net/content/images/2022/02/app-pool-setup-03-e.png" class="kg-image" alt="Running with Foundation" loading="lazy" width="392" height="234"></figure><h4 id="thats-it">That&apos;s it!</h4><p>You should be all set &#x2013; open your browser, and try to access the site at the domain you added when setting up the site in IIS.</p><h3 id="troubleshooting">Troubleshooting</h3><h5 id="windowscryptographicexception">WindowsCryptographicException</h5><p>Get a &#x201C;WindowsCryptographicException&#x201D; when you try to load the site? Double check that you updated the AppPool settings to use LocalSystem identity.</p><h5 id="get-a-syntax-error-while-assets-are-built">Get a syntax error while assets are built?</h5><!--kg-card-begin: markdown--><p><sub>[webpack-cli] <span style="color:red">SyntaxError: Invalid regular expression: /(\p{Uppercase_Letter}+|\p{Lowercase_Letter}|\d)(\p{Uppercase_Letter}+)/: Invalid escape</span></sub></p>
<!--kg-card-end: markdown--><p>Make sure you&apos;re on a recent version of Node.</p><h5 id="dont-see-anything">Don&apos;t see anything?</h5><p>Make sure your monitor is on.</p><h3 id="more-tips">More tips!</h3><h4 id="publishing-site-changes-while-running-under-iis">Publishing site changes while running under IIS</h4><p>After the site is running under IIS, for subsequent publish commands you need to stop the site&#x2019;s application pool before publishing. Otherwise, the files are locked by the app pool, and it will not deploy correctly.</p><p>To avoid this issue, you can manually add a file called &#x201C;app_offline.htm&#x201D; to the publish directory before publishing &#x2013; this tells IIS to release the files.</p><p>To automate this process: create a Powershell script called &quot;<em>publish.ps1</em>&quot; and put it in the root <em>/foundation</em> folder. Add the following lines to the file:</p><pre><code class="language-powershell">$pathToApp = &apos;.\publish&apos; 
New-Item -Path $pathToApp -Name &quot;app_offline.htm&quot; -ItemType &quot;file&quot; 
dotnet publish -c Debug -o $pathToApp /p:EnvironmentName=Development 
Remove-Item -Path $pathToApp\app_offline.htm </code></pre><p>Adjust the path in the first line as needed, based on your publish folder location. Run this script from Powershell via the command &#x201C;<em>.\publish.ps1</em>&#x201D; whenever you want to publish the site, instead of just the standard <em>dotnet publish</em> command we used earlier.</p><h4 id="changing-the-port-when-running-under-localhost">Changing the port when running under localhost </h4><p>Want to change the port the site runs on locally? Update the &#x201C;applicationUrl&#x201D; setting in the launchSettings.json file (<em>\src\Foundation\Properties\launchSettings.json</em>) </p><p>For example, to use port 8000, change that line to: </p><p>	<em>&quot;applicationUrl&quot;: &quot;https://localhost:8001;http://localhost:8000&quot; </em></p><h2 id="conclusions">Conclusions</h2><p>Hopefully this (much longer than I meant to) post will help you get the .NET 5 version of Foundation up and running locally. Have any questions? Feel free to reach out. Find an issue? Create an issue in the GitHub repo. Wish this article had more fun images? Me too friend, me too.</p><figure class="kg-card kg-image-card"><img src="https://blog.danisaacs.net/content/images/2022/02/foundation-on-linux.png" class="kg-image" alt="Running with Foundation" loading="lazy" width="1503" height="691" srcset="https://blog.danisaacs.net/content/images/size/w600/2022/02/foundation-on-linux.png 600w, https://blog.danisaacs.net/content/images/size/w1000/2022/02/foundation-on-linux.png 1000w, https://blog.danisaacs.net/content/images/2022/02/foundation-on-linux.png 1503w" sizes="(min-width: 720px) 720px"></figure>]]></content:encoded></item></channel></rss>